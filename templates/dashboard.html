{% extends "base.html" %}
{% block titulo %}Inicio{% endblock %}

{% block contenido %}
<h1 class="mb-4 text-primary">Inicio</h1>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
      <h5 class="card-title mb-0">üóìÔ∏è Tareas del d√≠a</h5>

      <div class="d-flex flex-wrap gap-2">
        <span class="kpi-pill bg-success-subtle text-success">
          Fundir pendientes: <strong>{{ tareas_fundir_pend|length }}</strong>
        </span>
        <span class="kpi-pill bg-primary-subtle text-primary">
          Pulir pendientes: <strong>{{ tareas_pulir_pend|length }}</strong>
        </span>
        <span class="kpi-pill bg-secondary-subtle text-secondary">
          Completadas hoy: <strong>{{ (tareas_fundir_comp|length + tareas_pulir_comp|length) }}</strong>
        </span>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('historial_tareas') }}">üìú Ver historial</a>
      </div>
    </div>

    <div class="row g-4">
      
      <div class="col-lg-6">
        <div class="section-header"><h6 class="mb-2">Fundir</h6></div>

        {% if current_user.rol == 'admin' %}
        <form action="{{ url_for('tareas_agregar') }}" method="POST" enctype="multipart/form-data" class="row g-2 align-items-end mb-3">
          <input type="hidden" name="tipo" value="fundir">
          <div class="col-md-5">
            <label class="form-label mb-1">Producto</label>
            <input name="producto" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Acabado</label>
            <input name="acabado" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">Imagen (opcional)</label>
            <input type="file" name="imagen" accept=".png,.jpg,.jpeg,.webp" class="form-control">
          </div>
          <div class="col-12">
            <button class="btn btn-success btn-sm">Agregar a Fundir</button>
          </div>
        </form>
        {% endif %}

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th>Acabado</th>
                <th>Imagen</th>
                <th style="width:160px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tareas_fundir_pend %}
              <tr>
                <td>{{ t.producto }}</td>
                <td>{{ t.acabado }}</td>
                <td>
                  {% if t.imagen %}
                    <a href="{{ url_for('static', filename=t.imagen) }}" target="_blank">
                      <img src="{{ url_for('static', filename=t.imagen) }}" style="height:48px;border-radius:6px">
                    </a>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </td>
                <td class="d-flex gap-1">
                  <form action="{{ url_for('tareas_completar', tarea_id=t.id) }}" method="POST">
                    <button class="btn btn-sm btn-outline-primary">Completar</button>
                  </form>
                  {% if current_user.rol == 'admin' %}
                  <form action="{{ url_for('tareas_eliminar', tarea_id=t.id) }}" method="POST"
                        onsubmit="return confirm('¬øEliminar esta tarea?');">
                    <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="text-center text-muted">Sin tareas pendientes</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if tareas_fundir_comp %}
        <div class="mt-3">
          <div class="small text-muted mb-1">Completadas hoy</div>
          <ul class="list-group list-group-flush">
            {% for t in tareas_fundir_comp %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>‚úîÔ∏è {{ t.producto }} ‚Äî {{ t.acabado }}</span>
              {% if current_user.rol == 'admin' %}
              <form action="{{ url_for('tareas_reabrir', tarea_id=t.id) }}" method="POST">
                <button class="btn btn-sm btn-outline-secondary">Reabrir</button>
              </form>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>

      
      <div class="col-lg-6">
        <div class="section-header"><h6 class="mb-2">Productos por pulir</h6></div>

        {% if current_user.rol == 'admin' %}
        <form action="{{ url_for('tareas_agregar') }}" method="POST" class="row g-2 align-items-end mb-3">
          <input type="hidden" name="tipo" value="pulir">
          <div class="col-md-6">
            <label class="form-label mb-1">Producto</label>
            <input name="producto" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label mb-1">Acabado</label>
            <input name="acabado" class="form-control" required>
          </div>
          <div class="col-12">
            <button class="btn btn-primary btn-sm">Agregar a Pulir</button>
          </div>
        </form>
        {% endif %}

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Producto</th>
                <th>Acabado</th>
                <th style="width:160px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for t in tareas_pulir_pend %}
              <tr>
                <td>{{ t.producto }}</td>
                <td>{{ t.acabado }}</td>
                <td class="d-flex gap-1">
                  <form action="{{ url_for('tareas_completar', tarea_id=t.id) }}" method="POST">
                    <button class="btn btn-sm btn-outline-primary">Completar</button>
                  </form>
                  {% if current_user.rol == 'admin' %}
                  <form action="{{ url_for('tareas_eliminar', tarea_id=t.id) }}" method="POST"
                        onsubmit="return confirm('¬øEliminar esta tarea?');">
                    <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="text-center text-muted">Sin tareas pendientes</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if tareas_pulir_comp %}
        <div class="mt-3">
          <div class="small text-muted mb-1">Completadas hoy</div>
          <ul class="list-group list-group-flush">
            {% for t in tareas_pulir_comp %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>‚úîÔ∏è {{ t.producto }} ‚Äî {{ t.acabado }}</span>
              {% if current_user.rol == 'admin' %}
              <form action="{{ url_for('tareas_reabrir', tarea_id=t.id) }}" method="POST">
                <button class="btn btn-sm btn-outline-secondary">Reabrir</button>
              </form>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# Solo para ADMIN: ver todo lo que est√° pulido pero a√∫n no pasado a producci√≥n #}
{% if current_user.rol == 'admin' %}
<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <span class="me-2">üì¶</span>
      <strong>Pulidos pendientes de pasar a producci√≥n</strong>
    </div>
    <span class="badge bg-info">
      Total: {{ registros_pulido_pendientes|length }}
    </span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Fecha</th>
            <th>Empleado</th>
            <th>Producto</th>
            <th>Acabado</th>
            <th>Cant.</th>
            <th style="width: 200px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if registros_pulido_pendientes %}
            {% for r in registros_pulido_pendientes %}
            <tr>
              <td>{{ r.fecha.strftime('%d/%m/%Y') }}</td>
              <td>{{ r.usuario.nombre }}</td>
              <td>{{ r.producto }}</td>
              <td>{{ r.acabado or '-' }}</td>
              <td>{{ r.cantidad }}</td>
              <td>
                <form action="{{ url_for('pulido_terminar', registro_id=r.id) }}"
                      method="POST"
                      onsubmit="return confirm('¬øMarcar como terminado y pasarlo a producci√≥n?');">
                  <button class="btn btn-sm btn-success">
                    Marcar terminado y pasar a producci√≥n
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center py-3 text-muted">
                No hay pulidos pendientes.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

{# Solo para operarios que pulen #}
{% if current_user.rol == 'operario' %}
<div class="card shadow-sm mb-4">
  <div class="card-header d-flex align-items-center">
    <span class="me-2">üßΩ</span>
    <strong>Registro de pulido del d√≠a</strong>
  </div>
  <div class="card-body">
    <form action="{{ url_for('registrar_pulido') }}" method="POST" class="row g-2">
      <div class="col-md-4">
        <label class="form-label mb-1">Producto</label>
        <input type="text" name="producto" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label mb-1">Acabado</label>
        <input type="text" name="acabado" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label mb-1">Cantidad</label>
        <input type="number" name="cantidad" class="form-control" min="1" value="1">
      </div>
      <div class="col-md-4">
  <label class="form-label mb-1">Categor√≠a</label>
  <select name="categoria_id" class="form-control" required>
    <option value="">Seleccionar categor√≠a...</option>
    {% for c in categorias_produccion %}
      <option value="{{ c.id }}">{{ c.nombre }}</option>
    {% endfor %}
  </select>
</div>
      <div class="col-md-12">
        <label class="form-label mb-1">Observaciones</label>
        <input type="text" name="observaciones" class="form-control" placeholder="Ej: Es Pedido O Producto Para Inventario">
      </div>

      <div class="col-12 mt-2">
        <button type="submit" class="btn btn-primary btn-sm">
          Registrar pulido
        </button>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Productos Pulidos</strong>

    <a href="{{ url_for('historial_pulido') }}" class="btn btn-primary btn-sm">
        üìú Ver historial de pulido
    </a>
  </div>

  <div class="card-body p-0">
    <table class="table table-sm mb-0 table-striped">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Acabado</th>
          <th>Cant.</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% if registros_pulido_hoy_usuario %}
          {% for r in registros_pulido_hoy_usuario %}
          <tr>
            <td>{{ r.producto }}</td>
            <td>{{ r.acabado or '-' }}</td>
            <td>{{ r.cantidad }}</td>
            <td>
              <span class="badge
                {% if r.estado == 'pulido' %} bg-warning text-dark
                {% elif r.estado == 'terminado' %} bg-success
                {% else %} bg-secondary {% endif %}">
                {{ r.estado }}
              </span>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="text-center py-3 text-muted">
              A√∫n no has registrado pulidos hoy.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endif %}

{% endblock %}

