{% extends "base.html" %}
{% block titulo %}{{ categoria_nombre }}{% endblock %}

{% block contenido %}
<div class="container mt-4">
  <h2 class="mb-3 text-primary text-center">{{ categoria_nombre }}</h2>
  <p class="text-center text-muted">Productos de esta categor√≠a</p>

<div class="text-center mb-4">
  {% set base = 'img/categorias/' + categoria_nombre|lower|replace(' ', '-') %}
  {% set img_jpg = base + '.jpg' %}
  {% set img_default = 'img/categorias/default.jpg' %}

  <img 
    src="{{ url_for('static', filename=img_jpg) }}"
    onerror="this.src='{{ url_for('static', filename=img_default) }}'"
    alt="{{ categoria_nombre }}"
    class="img-fluid rounded shadow-sm"
    style="max-height: 300px; object-fit: cover;"
  >
</div>

{% if productos %}
<form method="POST">
  <table class="table table-bordered table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>Nombre</th>
        <th>Acabado</th>
        <th>Cantidad</th>
        <th>Bodega</th>

        {% if categoria_nombre == "Sin categor√≠a" %}
          <th>Asignar categor√≠a</th>
        {% endif %}

        {% if current_user.rol == 'admin' %}
          <th>Acciones</th>  <!-- #Ô∏è‚É£ Nueva columna -->
        {% endif %}
      </tr>
    </thead>

    <tbody>
    {% for p in productos %}
      <tr>
        <td>{{ p.nombre }}</td>
        <td>{{ p.acabado or '-' }}</td>
        <td>{{ p.cantidad_actual }}</td>
        <td>{{ p.bodega or '-' }}</td>

        {% if categoria_nombre == "Sin categor√≠a" %}
          <td>
            <form method="POST" style="display:inline;">
              <div class="input-group">
                <select name="nueva_categoria" class="form-select">
                  <option value="0">Seleccionar...</option>
                  {% for c in categorias %}
                    <option value="{{ c.id }}">{{ c.nombre }}</option>
                  {% endfor %}
                </select>
                <input type="hidden" name="producto_id" value="{{ p.id }}">
                <button class="btn btn-primary btn-sm" type="submit">Guardar</button>
              </div>
            </form>
          </td>
        {% endif %}

        {% if current_user.rol == 'admin' %}
          <td>
            <!-- #Ô∏è‚É£ Bot√≥n Editar -->
            <a href="{{ url_for('producto_editar', producto_id=p.id) }}" class="btn btn-sm btn-warning">
              <i class="bi bi-pencil-square"></i> Editar
            </a>

            <!-- #Ô∏è‚É£ Bot√≥n Eliminar -->
            <form action="{{ url_for('producto_eliminar', producto_id=p.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-danger"
                      onclick="return confirm('¬øSeguro que deseas eliminar este producto? üóëÔ∏è')">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </td>
        {% endif %}
      </tr>
    {% endfor %}
    </tbody>
  </table>
</form>
{% else %}
  <p class="text-muted text-center">No hay productos en esta categor√≠a.</p>
{% endif %}

<div class="text-center mt-3">
  <a href="{{ url_for('produccion') }}" class="btn btn-outline-primary">‚Üê Volver a categor√≠as</a>
</div>

{% endblock %}
